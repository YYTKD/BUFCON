# ゆとシート チャットパレット → JET-PALLET 変換ツール 実装指示

## 概要
ゆとシートで出力されたチャットパレットのテキストを、JET-PALLET用のJSON形式に変換するHTMLツールを作成してください。

## 入力形式
ゆとシートのチャットパレット（.txtファイル）
- セクション見出し: `### ■非戦闘系` のような形式
- 判定コマンド: `2d+{変数} コマンド名` の形式
- 攻撃コマンド: `k数字[...]... 攻撃名` の形式
- 代入定義: `//変数名=式` の形式

## 出力形式
JET-PALLET用のJSON（以下の構造）:
```json
{
  "buffs": [...],
  "buffCategories": ["装備", "出目修正"],
  "judges": [...],
  "judgeCategories": [...],
  "attacks": [...],
  "attackCategories": [...],
  "userDictionary": [...]
}
```

## 処理仕様

### 1. セクション解析
- `### ■` で始まる行をカテゴリ名として抽出
- カテゴリ名から「■」と前後の空白を除去
- 以降のコマンドはそのカテゴリに属する

### 2. コマンド判別
- `2d` で始まる行 → 判定コマンド
- `k数字` で始まる行 → 攻撃コマンド
- `//変数=式` → 代入定義として保存
- `[宣]` で始まる行 → 無視
- その他 → 無視

### 3. 基本能力値判定の特殊処理
以下のパターンに一致する判定は名前を変換:
```
入力: 2d+{冒険者}+{器用B} 冒険者＋器用
出力: 器用判定|2d+{冒険者レベル}+(({器用}+//器用増強//)/6)
```
- コマンド名から「冒険者＋」を削除し、「判定」を追加
- 対象能力値: 器用、敏捷、筋力、生命、知力、精神

### 4. 変数展開ロジック

#### 展開ルール
1. 代入定義を再帰的に展開
2. 以下の変数は `//変数名//` 形式に変換（JET-PALLET代入記法）:
   - 増強系: `{器用増強}`, `{敏捷増強}`, `{筋力増強}`, `{生命増強}`, `{知力増強}`, `{精神増強}`
   - 修正系: `{命中修正}`, `{C修正}`, `{追加D修正}`, `{魔力修正}`, `{行使修正}`, `{魔法D修正}`, `{回復量修正}`, `{生命抵抗修正}`, `{精神抵抗修正}`, `{回避修正}`
   - 出目修正: `{クリレイ}`, `{必殺効果}`
3. 基本能力値（`{器用}`, `{敏捷}`, `{筋力}`, `{生命}`, `{知力}`, `{精神}`）はそのまま
4. その他の変数は完全展開

#### 展開例
```
入力: {レンジャー技巧}
代入: //レンジャー技巧={レンジャー}+{器用B}
代入: //器用B=(({器用}+{器用増強})/6)
↓
出力: {レンジャー}+(({器用}+//器用増強//)/6)
```

### 5. 判定の変換

#### 形式
```
判定名|判定ロール
```

#### 処理
1. コマンド名（`2d...` の後ろ）を判定名として使用
2. `2d+{変数1}+{変数2}...` の変数部分を展開
3. 固定値（`+1`, `-2`など）はそのまま保持

#### 例
```
入力: 2d+{レンジャー技巧} レンジャー技巧
出力: レンジャー技巧|2d+{レンジャー}+(({器用}+//器用増強//)/6)
```

### 6. 攻撃の変換

#### 形式
```
攻撃名|攻撃ロール
```

#### 攻撃名の抽出
1. `ダメージ／` または `回復量／` を削除
2. `[魔]`, `[○]` などの接頭辞を削除
3. 残りを攻撃名とする

#### 処理
1. `k数字[...]...` の威力式を解析
2. 変数を展開
3. 固定ボーナス（`+1+1`など）はそのまま保持

#### 例
```
入力: k17[(10+{C修正})]+{追加D1}+{追加D修正}{出目修正} ダメージ／[魔]魔剣〈テストソード〉1H両
出力: 魔剣〈テストソード〉1H両|k17[(10+//C修正//)]+({ファイター}+({筋力}+//筋力増強//)/6+1+1)+//追加D修正////出目修正//
```

### 7. バフの自動生成

#### 装備カテゴリ
カテゴリ名: `装備`

6つの能力値分のバフを生成:
```
バフ名|効果先|簡易メモ|効果|ターン|カラーコード
器用装備|器用判定|器用+n|+0||#6272A4
敏捷装備|敏捷判定|敏捷+n|+0||#6272A4
筋力装備|筋力判定|筋力+n|+0||#6272A4
生命装備|生命判定|生命+n|+0||#6272A4
知力装備|知力判定|知力+n|+0||#6272A4
精神装備|精神判定|精神+n|+0||#6272A4
```

#### 出目修正カテゴリ
カテゴリ名: `出目修正`

2つのバフを生成:
```
名前を入力|>>武器攻撃|クリ値-n|$+0||#8BE9FD
名前を入力|>>武器攻撃|必殺効果|#+0||#8BE9FD
```

### 8. ユーザー辞書の生成

変換中に `//変数名//` 形式に変換した変数を収集し、ユーザー辞書に追加:
```json
[
  {
    "id": "uuid-generated",
    "text": "//命中修正//",
    "category": "代入記法",
    "usage": 0
  }
]
```

- 重複排除
- UUID は `crypto.randomUUID()` または同等の方法で生成

### 9. カテゴリの一括追加記法

判定と攻撃の出力は、カテゴリごとにグループ化:
```
<非戦闘系>
器用判定|2d+{冒険者レベル}+(({器用}+//器用増強//)/6)
敏捷判定|2d+{冒険者レベル}+(({敏捷}+//敏捷増強//)/6)
</非戦闘系>

<魔法系>
神聖魔法行使|2d+{神聖魔法}+//行使修正//
</魔法系>
```

## UI仕様

### レイアウト
- 既存の `manual/tools/converter.html` のスタイルを踏襲
- テーマ: Dracula (`styles/theme-dracula.css`)
- フォント: M PLUS 1c

### 入力エリア
- タイトル: "入力"
- テキストエリア: `<textarea id="paletteInput">`
- プレースホルダー: "ゆとシートのチャットパレットを貼り付けてください"
- ファイル選択ボタン付き（.txt対応）

### 出力エリア
- タイトル: "出力"
- テキストエリア: `<textarea id="jsonOutput" readonly>`
- プレースホルダー: "変換されたJSONがここに表示されます"

### ボタン
1. **変換する** - 変換を実行
2. **コピー** (secondary) - JSONをクリップボードにコピー
3. **クリア** (ghost) - 入力・出力をクリア

### ステータスメッセージ
- 変換成功: "変換が完了しました"
- エラー: "変換に失敗しました: [エラー内容]"
- コピー成功: "クリップボードにコピーしました"

## エラーハンドリング

### 入力検証
- 空の入力 → "チャットパレットを貼り付けてください"
- 代入定義が見つからない → "代入定義（//変数=式）が見つかりません"

### 変数展開エラー
- 循環参照検出 → エラーメッセージ表示
- 未定義変数 → そのまま残す（エラーにしない）

## ファイル構成

### 新規作成ファイル
- `manual/tools/palette-converter.html` - メインHTML
- `manual/tools/palette-converter.js` - 変換ロジック

### 既存ファイルの参照
- `styles/theme-dracula.css` - テーマ
- `styles/main.css` - スタイル、命名規則などを流用

## 実装の優先順位

1. **フェーズ1**: 基本的な変換機能
   - 代入定義の解析
   - 判定・攻撃の抽出
   - 変数展開ロジック

2. **フェーズ2**: バフ生成
   - 装備カテゴリ
   - 出目修正カテゴリ

3. **フェーズ3**: ユーザー辞書生成

4. **フェーズ4**: UI実装とエラーハンドリング

## テストケース

### 入力例
提供されたファイル `運営用テストキャラクターα_チャットパレット.txt` を使用

### 期待される出力
- 判定: 9件以上（非戦闘系、魔法系など）
- 攻撃: 3件（魔剣、バスタードソード1H、2H）
- バフ: 8件（装備6件 + 出目修正2件）
- ユーザー辞書: 10件以上（変換で使用した変数）

## 注意事項

1. 既存のJET-PALLETの変換ツール（`manual/tools/converter.html`）とは別ファイルとして作成
2. コードは読みやすく、コメントを適切に配置
3. 変数名は意味のあるものを使用（`i`, `j` などの短縮形は避ける）
4. エラーメッセージはユーザーフレンドリーに