<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>JET-PALLET ユーザーマニュアル</title>
  <style>
    :root {
      --bg: #282a36;
      --paper: #2f3142;
      --ink: #f8f8f2;
      --muted: #9aa2d7;
      --brand: #bd93f9;
      --brand-2: #ff79c6;
      --line: rgba(248, 248, 242, .12);
      --shadow: 0 10px 24px rgba(0, 0, 0, .35);
      --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    html,
    body {
      background: radial-gradient(1200px 600px at 50% 0%, rgba(189, 147, 249, .18), transparent 60%), var(--bg);
      color: var(--ink);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Sans", "Noto Sans JP", "Yu Gothic", Meiryo, sans-serif;
      line-height: 1.75;
    }

    a {
      color: #8be9fd;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    .topbar {
      position: sticky;
      top: 0;
      z-index: 999;
      backdrop-filter: blur(10px);
      background: rgba(40, 42, 54, .85);
      border-bottom: 1px solid var(--line);
    }

    .topbar-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 800;
      letter-spacing: .02em;
    }

    .brand-badge {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      box-shadow: inset 0 0 0 1px rgba(248, 248, 242, .25);
    }

    .brand-title {
      font-size: 15px;
    }

    .brand-sub {
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
    }

    .layout {
      max-width: 1200px;
      margin: 18px auto 64px;
      padding: 0 16px;
      display: grid;
      grid-template-columns: 280px minmax(0, 1fr);
      gap: 18px;
    }

    .sidebar {
      position: sticky;
      top: 72px;
      align-self: start;
      background: rgba(47, 49, 66, .9);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .sidebar .toc-head {
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(189, 147, 249, .18), transparent);
    }

    .sidebar .toc-head h2 {
      margin: 0;
      font-size: 13px;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: #f8f8f2;
    }

    .sidebar .toc {
      padding: 10px 14px 14px;
      max-height: calc(100vh - 120px);
      overflow: auto;
    }

    .toc-list {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .toc-list li {
      margin: 0;
      padding: 0;
    }

    .toc-list a {
      display: block;
      padding: 7px 8px;
      border-radius: 10px;
      color: #f8f8f2;
      border: 1px solid transparent;
    }

    .toc-list a:hover {
      background: rgba(189, 147, 249, .16);
      border-color: rgba(189, 147, 249, .3);
      text-decoration: none;
    }

    .toc-list ul {
      list-style: none;
      margin: 6px 0 8px 12px;
      padding: 0;
      border-left: 1px dashed rgba(189, 147, 249, .45);
    }

    .paper {
      background: var(--paper);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .hero {
      padding: 22px 22px 18px;
      border-bottom: 1px solid var(--line);
      background:
        linear-gradient(135deg, rgba(189, 147, 249, .22), transparent 55%),
        linear-gradient(0deg, rgba(255, 121, 198, .18), transparent 60%);
    }

    .hero h1 {
      margin: 0 0 6px;
      font-size: 26px;
      line-height: 1.3;
      letter-spacing: .02em;
    }

    .hero .meta {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      color: var(--muted);
      font-size: 13px;
    }

    .hero .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(189, 147, 249, .35);
      background: rgba(189, 147, 249, .16);
    }

    .article {
      padding: 18px 22px 30px;
    }

    hr {
      border: 0;
      border-top: 1px solid var(--line);
      margin: 18px 0;
    }

    h2 {
      margin: 28px 0 10px;
      padding-left: 12px;
      border-left: 5px solid rgba(255, 121, 198, .8);
      font-size: 20px;
    }

    h3 {
      margin: 18px 0 8px;
      font-size: 16px;
      padding-left: 10px;
      border-left: 4px solid rgba(189, 147, 249, .6);
    }

    h4 {
      margin: 16px 0 8px;
      font-size: 14px;
      color: #f8f8f2;
    }

    p {
      margin: 10px 0;
    }

    ul,
    ol {
      margin: 10px 0 10px 22px;
      padding: 0;
    }

    li {
      margin: 4px 0;
    }

    blockquote {
      margin: 14px 0;
      padding: 12px 14px;
      border-left: 5px solid rgba(255, 184, 108, .7);
      background: rgba(255, 184, 108, .12);
      border-radius: 12px;
    }

    code {
      font-family: var(--mono);
      font-size: 0.95em;
      padding: 0.1em 0.35em;
      border-radius: 8px;
      background: rgba(248, 248, 242, .12);
    }

    pre {
      background: #1f2230;
      color: #f8f8f2;
      padding: 14px 14px;
      border-radius: 14px;
      overflow: auto;
      border: 1px solid rgba(248, 248, 242, .12);
    }

    pre code {
      background: transparent;
      padding: 0;
      color: inherit;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0;
      overflow: hidden;
      border-radius: 12px;
      border: 1px solid var(--line);
    }

    th,
    td {
      padding: 10px 10px;
      border-bottom: 1px solid var(--line);
      vertical-align: top;
    }

    th {
      background: rgba(189, 147, 249, .18);
      text-align: left;
    }

    tr:last-child td {
      border-bottom: 0;
    }

    details {
      margin: 14px 0;
      border: 1px solid var(--line);
      border-radius: 12px;
      overflow: hidden;
      background: rgba(0, 0, 0, .15);
    }

    summary {
      cursor: pointer;
      padding: 12px 14px;
      font-weight: 700;
      background: rgba(189, 147, 249, .2);
    }

    details[open] summary {
      border-bottom: 1px solid var(--line);
    }

    details>*:not(summary) {
      padding: 10px 14px 14px;
    }

    .admonition {
      margin: 14px 0;
      border-radius: 14px;
      border: 1px solid var(--line);
      overflow: hidden;
      box-shadow: 0 6px 18px rgba(0, 0, 0, .3);
    }

    .admonition-title {
      padding: 10px 12px;
      font-weight: 800;
      font-size: 13px;
      letter-spacing: .02em;
      border-bottom: 1px solid var(--line);
    }

    .admonition-body {
      padding: 10px 12px;
      background: rgba(47, 49, 66, .9);
    }

    .admonition.note .admonition-title {
      background: rgba(139, 233, 253, .18);
    }

    .admonition.tip .admonition-title {
      background: rgba(80, 250, 123, .18);
    }

    .admonition.warning .admonition-title {
      background: rgba(255, 184, 108, .22);
    }

    kbd {
      font-family: var(--mono);
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid rgba(248, 248, 242, .2);
      background: rgba(68, 71, 90, .85);
      box-shadow: inset 0 -2px 0 rgba(0, 0, 0, .35);
    }

    .footer {
      color: var(--muted);
      font-size: 12px;
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid var(--line);
    }

    .fab {
      position: fixed;
      right: 16px;
      bottom: 16px;
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: 1px solid rgba(189, 147, 249, .45);
      background: rgba(47, 49, 66, .9);
      box-shadow: var(--shadow);
      display: grid;
      place-items: center;
      color: #f8f8f2;
    }

    .fab:hover {
      background: rgba(189, 147, 249, .2);
      text-decoration: none;
    }

    @media (max-width: 980px) {
      .layout {
        grid-template-columns: 1fr;
      }

      .sidebar {
        position: relative;
        top: auto;
      }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="brand-badge" aria-hidden="true"></div>
        <div>
          <div class="brand-title">JET-PALLET ユーザーマニュアル</div>
          <div class="brand-sub">読みやすいHTML版（ローカル閲覧用）</div>
        </div>
      </div>
    </div>
  </div>

  <div class="layout">
    <aside class="sidebar">
      <div class="toc-head">
        <h2>Contents</h2>
      </div>
      <nav class="toc" aria-label="目次">
        <ul class="toc-list" id="tocList"></ul>
      </nav>
    </aside>

    <main class="paper">
      <header class="hero">
        <h1>JET-PALLET ユーザーマニュアル v2.0.0</h1>
        <div class="meta">
          <span class="pill">参考：FF14 ロードストーンのパッチノート風レイアウト</span>
          <span class="pill">生成元：Markdown</span>
        </div>
      </header>

      <article class="article" id="top"></article>
    </main>
  </div>

  <a class="fab" href="#top" aria-label="ページ上部へ">↑</a>

  <script src="manual/markdown.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const tocList = document.getElementById('tocList');
      const article = document.querySelector('article.article');
      if (!tocList || !article) return;

      const buildToc = (headings) => {
        tocList.innerHTML = '';
        const listStack = [tocList];
        let lastLi = null;

        headings.forEach((heading) => {
          const level = Math.min(Math.max(heading.level, 1), 3);
          const title = heading.title.trim();
          if (!title) return;

          while (listStack.length < level) {
            if (!lastLi) break;
            const sublist = document.createElement('ul');
            lastLi.appendChild(sublist);
            listStack.push(sublist);
          }
          while (listStack.length > level) {
            listStack.pop();
          }

          const li = document.createElement('li');
          const link = document.createElement('a');
          link.href = `#${heading.id}`;
          link.textContent = title;
          li.appendChild(link);
          listStack[listStack.length - 1].appendChild(li);
          lastLi = li;
        });
      };

      const escapeHtml = (text) =>
        text
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');

      const parseInline = (text) => {
        const parts = text.split(/(`[^`]*`)/g);
        return parts
          .map((part) => {
            if (part.startsWith('`') && part.endsWith('`')) {
              return `<code>${escapeHtml(part.slice(1, -1))}</code>`;
            }
            let escaped = escapeHtml(part);
            escaped = escaped.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>');
            escaped = escaped.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            escaped = escaped.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            return escaped;
          })
          .join('');
      };

      const parseMarkdown = (markdown) => {
        const lines = markdown.replace(/\r\n?/g, '\n').split('\n');
        const headings = [];
        const ensureId = window.markdownUtils?.createHeadingIdGenerator?.() ?? ((title) => title);
        const listStack = [];
        let html = '';
        let paragraph = [];
        let inCode = false;
        let codeFence = '';
        let codeLines = [];

        const closeLists = (targetDepth = 0) => {
          while (listStack.length > targetDepth) {
            const current = listStack.pop();
            if (current.openLi) {
              html += '</li>';
            }
            html += `</${current.type}>`;
          }
        };

        const flushParagraph = () => {
          if (!paragraph.length) return;
          const parts = paragraph.map((line) => {
            if (line.endsWith('  ')) {
              return `${parseInline(line.trimEnd())}<br />`;
            }
            return parseInline(line);
          });
          html += `<p>${parts.join(' ')}</p>`;
          paragraph = [];
        };

        const openList = (type) => {
          html += `<${type}>`;
          listStack.push({ type, openLi: false });
        };

        const closeAllBlocks = () => {
          flushParagraph();
          closeLists();
        };

        lines.forEach((line) => {
          if (inCode) {
            if (line.startsWith(codeFence)) {
              const code = escapeHtml(codeLines.join('\n'));
              html += `<pre><code>${code}</code></pre>`;
              inCode = false;
              codeFence = '';
              codeLines = [];
              return;
            }
            codeLines.push(line);
            return;
          }

          const fenceMatch = line.match(/^```/);
          if (fenceMatch) {
            closeAllBlocks();
            inCode = true;
            codeFence = fenceMatch[0];
            codeLines = [];
            return;
          }

          if (line.trim() === '') {
            flushParagraph();
            closeLists();
            return;
          }

          const trimmed = line.trim();
          if (trimmed.startsWith('<')) {
            closeAllBlocks();
            html += `${line}\n`;
            return;
          }

          const hrMatch = trimmed.match(/^(-{3,}|\*{3,}|_{3,})$/);
          if (hrMatch) {
            closeAllBlocks();
            html += '<hr />';
            return;
          }

          const headingMatch = line.match(/^(#{1,6})\s+(.*)$/);
          if (headingMatch) {
            closeAllBlocks();
            const level = headingMatch[1].length;
            const title = headingMatch[2].trim();
            const id = ensureId(title);
            const safeTitle = parseInline(title);
            html += `<h${level} id="${id}">${safeTitle}</h${level}>`;
            headings.push({ level, title, id });
            return;
          }

          const listMatch = line.match(/^(\s*)([-*+]|\d+\.)\s+(.*)$/);
          if (listMatch) {
            flushParagraph();
            const indent = Math.floor(listMatch[1].length / 2);
            const marker = listMatch[2];
            const content = listMatch[3];
            const type = marker.endsWith('.') ? 'ol' : 'ul';

            if (listStack.length < indent + 1) {
              while (listStack.length < indent + 1) {
                openList(type);
              }
            } else if (listStack.length > indent + 1) {
              closeLists(indent + 1);
            }

            const current = listStack[listStack.length - 1];
            if (!current || current.type !== type) {
              closeLists(listStack.length - 1);
              openList(type);
            } else if (current.openLi) {
              html += '</li>';
              current.openLi = false;
            }

            html += `<li>${parseInline(content)}`;
            listStack[listStack.length - 1].openLi = true;
            return;
          }

          paragraph.push(line);
        });

        if (inCode) {
          const code = escapeHtml(codeLines.join('\n'));
          html += `<pre><code>${code}</code></pre>`;
        }

        flushParagraph();
        closeLists();

        return { html, headings };
      };

      const renderFallback = (message) => {
        article.innerHTML = `<p>${message}</p>`;
        tocList.innerHTML = '';
      };

      fetch('manual/content.md')
        .then((response) => {
          if (!response.ok) {
            throw new Error('manual/content.md not found');
          }
          return response.text();
        })
        .then((markdown) => {
          const { html, headings } = parseMarkdown(markdown);
          article.innerHTML = html;
          buildToc(headings);
        })
        .catch((error) => {
          console.error(error);
          renderFallback('マニュアルの読み込みに失敗しました。');
        });
    });

    // Smooth scroll for internal anchors
    document.addEventListener('click', (e) => {
      const a = e.target.closest('a[href^="#"]');
      if (!a) return;
      const id = a.getAttribute('href').slice(1);
      const el = document.getElementById(id);
      if (!el) return;
      e.preventDefault();
      el.scrollIntoView({ behavior: 'smooth', block: 'start' });
      history.pushState(null, '', '#' + id);
    });
  </script>
</body>

</html>
